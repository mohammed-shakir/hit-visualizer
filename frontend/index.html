<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Live Hit Visualizer</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />

    <link
      rel="stylesheet"
      href="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css"
    />

    <style>
      :root {
        --bg-color: #020617;
        --card-bg: rgba(15, 23, 42, 0.9);
        --card-border: rgba(148, 163, 184, 0.4);
        --text-muted: #9ca3af;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.4);
        --danger: #f97373;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          "SF Pro Text",
          "Inter",
          sans-serif;
        background:
          radial-gradient(circle at top, #020617 0, #020617 40%, #020617 100%),
          var(--bg-color);
        color: #e5e7eb;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .status-overlay {
        position: fixed;
        bottom: 1.5rem;
        left: 1.5rem;
        padding: 0.4rem 0.9rem 0.4rem 0.7rem;
        background: var(--card-bg);
        color: var(--text-muted);
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border-radius: 999px;
        border: 1px solid var(--card-border);
        backdrop-filter: blur(12px);
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        z-index: 10;
        pointer-events: none;
        box-shadow:
          0 18px 45px rgba(15, 23, 42, 0.9),
          0 0 0 1px rgba(15, 23, 42, 0.8);
      }

      .status-count {
        display: inline-flex;
        align-items: baseline;
        gap: 0.25rem;
        margin-left: 0.9rem;
        padding-left: 0.9rem;
        border-left: 1px solid rgba(148, 163, 184, 0.35);
        font-feature-settings:
          "tnum" 1,
          "lnum" 1;
      }

      .status-count-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        opacity: 0.8;
      }

      .status-count-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: #f9fafb;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent-soft);
        box-shadow: 0 0 16px rgba(56, 189, 248, 0.9);
        flex-shrink: 0;
        transition:
          background 180ms ease-out,
          box-shadow 180ms ease-out;
      }

      .status-overlay[data-status="connected"] .status-dot {
        background: var(--accent);
        box-shadow: 0 0 18px rgba(56, 189, 248, 0.95);
      }

      .status-overlay[data-status="disconnected"] .status-dot,
      .status-overlay[data-status="error"] .status-dot {
        background: var(--danger);
        box-shadow: 0 0 12px rgba(248, 113, 113, 0.9);
      }

      .status-text {
        opacity: 0.9;
      }

      .maplibregl-ctrl-top-right {
        margin-top: 1.25rem;
        margin-right: 1.25rem;
      }

      .maplibregl-ctrl-group {
        border-radius: 999px;
        overflow: hidden;
        border: 1px solid var(--card-border);
        box-shadow:
          0 12px 30px rgba(15, 23, 42, 0.85),
          0 0 0 1px rgba(15, 23, 42, 1);
        background: rgba(15, 23, 42, 0.9);
      }

      .maplibregl-ctrl-group button {
        width: 34px;
        height: 34px;
        background: transparent;
      }

      .maplibregl-ctrl-group button + button {
        border-top: 1px solid rgba(30, 41, 59, 0.9);
      }

      .maplibregl-ctrl button .maplibregl-ctrl-icon {
        filter: invert(80%);
        opacity: 0.9;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="status-overlay" id="status" data-status="connecting">
      <span class="status-dot"></span>
      <span class="status-text">Connectingâ€¦</span>
      <span class="status-count">
        <span class="status-count-label">Hits</span>
        <span class="status-count-value" id="hit-count">0</span>
      </span>
    </div>

    <script src="https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.js"></script>

    <script>
      (function () {
        const map = new maplibregl.Map({
          container: "map",
          style:
            "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",
          center: [16.32, 62.38],
          zoom: 4.2,
        });

        map.addControl(new maplibregl.NavigationControl(), "top-right");

        const statusEl = document.getElementById("status");
        const statusTextEl = statusEl
          ? statusEl.querySelector(".status-text")
          : null;

        const hitCountEl = document.getElementById("hit-count");
        let hitCount = 0;

        map.on("load", function () {
          map.addSource("hits", {
            type: "geojson",
            data: {
              type: "FeatureCollection",
              features: [],
            },
          });

          // Soft outer glow
          map.addLayer({
            id: "hits-glow",
            type: "circle",
            source: "hits",
            paint: {
              "circle-radius": [
                "interpolate",
                ["linear"],
                ["get", "ageMs"],
                0,
                0,
                150,
                9,
                1000,
                0,
              ],
              "circle-color": "rgba(56, 189, 248, 1)", // cyan
              "circle-opacity": [
                "interpolate",
                ["linear"],
                ["get", "ageMs"],
                0,
                0,
                60,
                0.45,
                1000,
                0,
              ],
              "circle-blur": 1.8,
            },
          });

          // Tiny bright core
          map.addLayer({
            id: "hits-core",
            type: "circle",
            source: "hits",
            paint: {
              "circle-radius": 3,
              "circle-color": "rgba(241, 245, 249, 1)", // near white
              "circle-stroke-color": "rgba(56, 189, 248, 0.9)",
              "circle-stroke-width": 0.8,
              "circle-opacity": [
                "interpolate",
                ["linear"],
                ["get", "ageMs"],
                0,
                0,
                40,
                0.95,
                1000,
                0,
              ],
            },
          });

          const hits = [];
          const lifetimeMs = 1000; // ms
          const src = map.getSource("hits");

          const featureCollection = {
            type: "FeatureCollection",
            features: [],
          };

          const UPDATE_INTERVAL_MS = 33;
          let lastUpdate = 0;

          function updateHits(now) {
            if (!src) {
              requestAnimationFrame(updateHits);
              return;
            }

            if (now - lastUpdate < UPDATE_INTERVAL_MS) {
              requestAnimationFrame(updateHits);
              return;
            }
            lastUpdate = now;

            let write = 0;
            for (let read = 0; read < hits.length; read++) {
              if (now - hits[read].added <= lifetimeMs) {
                if (write !== read) {
                  hits[write] = hits[read];
                }
                write++;
              }
            }
            hits.length = write;

            const feats = featureCollection.features;
            const targetLen = hits.length;

            for (let i = feats.length; i < targetLen; i++) {
              feats.push({
                type: "Feature",
                geometry: {
                  type: "Point",
                  coordinates: [0, 0],
                },
                properties: {
                  ageMs: 0,
                },
              });
            }

            if (feats.length > targetLen) {
              feats.length = targetLen;
            }

            for (let i = 0; i < targetLen; i++) {
              const h = hits[i];
              const f = feats[i];

              const coords = f.geometry.coordinates;
              coords[0] = h.lon;
              coords[1] = h.lat;
              f.properties.ageMs = now - h.added;
            }

            src.setData(featureCollection);

            requestAnimationFrame(updateHits);
          }

          requestAnimationFrame(updateHits);

          const wsProtocol =
            window.location.protocol === "https:" ? "wss:" : "ws:";
          const wsUrl = wsProtocol + "//" + window.location.host + "/ws";
          const ws = new WebSocket(wsUrl);

          function setStatus(state, text) {
            if (!statusEl || !statusTextEl) return;
            statusEl.dataset.status = state;
            statusTextEl.textContent = text;
          }

          ws.onopen = function () {
            setStatus("connected", "Live");
            console.log("WebSocket connected:", wsUrl);
          };

          ws.onclose = function () {
            setStatus("disconnected", "Disconnected");
            console.log("WebSocket closed");
          };

          ws.onerror = function (err) {
            setStatus("error", "Error");
            console.error("WebSocket error", err);
          };

          let dropCounter = 0;
          const ENABLE_SAMPLING = false;
          const SAMPLE_EVERY_N = 2;
          const MAX_IN_FLIGHT_HITS = 1500;

          ws.onmessage = function (event) {
            try {
              if (ENABLE_SAMPLING && hits.length > MAX_IN_FLIGHT_HITS) {
                dropCounter++;
                if (dropCounter % SAMPLE_EVERY_N !== 0) {
                  return;
                }
              }

              const data = JSON.parse(event.data);

              if (
                typeof data.lon !== "number" ||
                typeof data.lat !== "number"
              ) {
                return;
              }

              hits.push({
                lon: data.lon,
                lat: data.lat,
                added: performance.now(),
              });

              hitCount++;
              if (hitCountEl) {
                hitCountEl.textContent = hitCount.toLocaleString("sv-SE");
              }
            } catch (e) {
              console.error("Failed to parse hit message", e, event.data);
            }
          };

          window.addEventListener("beforeunload", function () {
            try {
              ws.close();
            } catch (e) {}
          });
        });
      })();
    </script>
  </body>
</html>
